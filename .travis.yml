# autogenerated file; do not edit
language: c

addons:
 apt:
  packages:
   - php-cli
   - php-pear
   - libcurl4-openssl-dev
   - libidn11-dev
   - libidn2-0-dev
   - libicu-dev
   - libevent-dev
   - libbrotli-dev

dist: xenial

cache:
 apt: true
 directories:
  - $HOME/cache
before_cache:
 - find $HOME/cache -name '*.gcda' -o -name '*.gcno' -delete

env:
 - PHP=master enable_debug=yes enable_zts=yes enable_iconv=yes
 - PHP=8.0 with_http_libicu_dir=no with_http_libidn_dir=no with_http_libidn2_dir=no with_http_libcurl_dir=no with_http_libevent_dir=no with_http_libbrotli_dir=no
 - PHP=8.0 enable_debug=no enable_zts=no enable_iconv=yes
 - PHP=8.0 enable_debug=yes enable_zts=no enable_iconv=yes
 - PHP=8.0 enable_debug=no enable_zts=yes enable_iconv=yes
 - PHP=8.0 enable_debug=yes enable_zts=yes enable_iconv=yes
 - CFLAGS='-O0 -g --coverage' CXXFLAGS='-O0 -g --coverage' PHP=8.0 enable_iconv=yes with_http_libicu_dir=yes with_http_libidn_dir=no with_http_libidn2_dir=no 
 - CFLAGS='-O0 -g --coverage' CXXFLAGS='-O0 -g --coverage' PHP=8.0 enable_iconv=yes with_http_libidn_dir=yes with_http_libicu_dir=no with_http_libidn2_dir=no 
 - CFLAGS='-O0 -g --coverage' CXXFLAGS='-O0 -g --coverage' PHP=8.0 enable_iconv=yes with_http_libidn2_dir=yes with_http_libicu_dir=no with_http_libidn_dir=no 

matrix:
 fast_finish: true
 allow_failures:
  - env: PHP=master enable_debug=yes enable_zts=yes enable_iconv=yes

install:
 - |
   if test "$PHP" = master; then \
     make -f travis/pecl/Makefile reconf; \
     make -f travis/pecl/Makefile pecl-rm pecl-clean PECL=m6w6/ext-raphf.git:raphf:master; \
   fi
 - make -f travis/pecl/Makefile php || make -f travis/pecl/Makefile clean php
 - make -f travis/pecl/Makefile pecl PECL=m6w6/ext-raphf.git:raphf:master
 - |
   if test -n "$PECLs"; then \
     IFS=$','; \
     for pecl in $PECLs; do \
       make -f travis/pecl/Makefile pecl PECL=$pecl; \
     done; \
     unset IFS; \
   fi

script:
 - make -f travis/pecl/Makefile ext PECL=http
 - make -f travis/pecl/Makefile test

after_script:
 - make -f travis/pecl/Makefile cppcheck
after_failure:
 - test -e tests/helper/server.log && cat tests/helper/server.log
after_success:
 - test -n "$CFLAGS" && cd src/.libs && bash <(curl -s https://codecov.io/bash) -X xcode -X coveragepy

notifications:
 webhooks:
  urls:
   - https://webhooks.gitter.im/e/28d35158ac7e385bd14d
  on_success: change
  on_failure: always
  on_start: never
